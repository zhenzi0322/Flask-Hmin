
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Python之aiohttp异步请求库 - 书阁园</title>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <link href="/static/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content="Python,aiohttp,异步,请求">
    <meta name="description" content="一.aiohttp介绍

aiohttp是一个为Python提供异步HTTP客户端/服务端编程，基于asyncio（Python用于支持异步编程的标准库）的异步库。

[aiohttp官方文档](https://docs.aiohttp.org/en/stable/index.htmlaiohttpinstallation)

(一).安装


pipins">

        <link rel="stylesheet" href="/static/fontawesome/css/all.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap1.min.css">
        <link rel="stylesheet" href="/static/index.css">


    <link rel="stylesheet" href="/static/detail.css">
    <link rel="stylesheet" href="/static/main.9d5733d3.min.css">

</head>
<body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="">
    <div class="container" style="min-height:600px;">

            <header class="row" style="margin-bottom:.8rem;">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">书阁园</a>
            <button aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                    class="navbar-toggler collapsed" data-bs-target="#navbarSupportedContent" data-bs-toggle="collapse"
                    type="button"><span class="navbar-toggler-icon"></span></button>
            <div class="navbar-collapse collapse" id="navbarSupportedContent" style="">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

                        <li class="nav-item"><a class="nav-link" href="/login">登录</a></li>

                </ul>
                <form class="d-flex" role="search" action="/search">
                    <input class="form-control me-2" name="keyword" autocomplete="off" type="search" placeholder="搜索内容..." aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit"><i class="fa fa-search"></i></button>
                </form>
            </div>
        </div>
    </nav>
</header>




    <div class="position-fixed top-1" style="z-index:999;left:50%;transform: translate(-50%, -50%);">
        <div class="toast align-items-center text-white bg-primary" id="liveToast" role="alert" aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex justify-content-center">
                <div class="toast-body">
                    代码已复制到剪贴板
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10" id="c_left">
            <h1 class="h1 text-center mt-3 mb-3">Python之aiohttp异步请求库</h1>
            <p class="text-muted fst-italic mb-2">
                作者：
                    <a href="/u/zhenzi0322"
                       target="_blank">zhenzi0322</a>
                发布于: 12天前
                <span></span>
            </p>
            <div class="about_author">



                    <p>分类：<a class="badge bg-success text-decoration-none link-light"
                             href="/u/zhenzi0322/category/11">Python第三方模块</a>
                    </p>

            </div>

            <main style="min-height:30rem;" class="markdown-body mt-3 mb-5 md-typeset" id="kCatelog">
                <h2 id="%E4%B8%80-aiohttp%E4%BB%8B%E7%BB%8D">一. aiohttp介绍</h2>
<p><code>aiohttp</code>是一个为<code>Python</code>提供异步<code>HTTP</code>客户端/服务端编程，基于<code>asyncio</code>（Python用于支持异步编程的标准库）的异步库。</p>
<h3 id="%E4%B8%80-%E5%AE%89%E8%A3%85">(一). 安装</h3>
<p><div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>pip install aiohttp[speedups]
</code></pre></div>
上面的安装命令会安装<code>aiohttp</code>和<code>asyncio</code>等模块。</p>
<h3 id="%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3">官方文档</h3>
<p><a href="https://docs.aiohttp.org/en/stable/">https://docs.aiohttp.org/en/stable/</a></p>
<h2 id="%E4%BA%8C-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8">二. 客户端的简单使用</h2>
<h3 id="%E4%B8%80-aiohttp%E7%9A%84get%E8%AF%B7%E6%B1%82">(一). aiohttp的get请求</h3>
<h4 id="1-%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82">1. 简单请求</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/get&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;状态码:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;请求方式&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Content-type:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="10 "></span>            <span class="n">data_dict</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
<span class="linenos" data-linenos="12 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<h4 id="2-get%E4%BC%A0%E5%8F%82">2. GET传参</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;往事&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/get&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># url会进行自动编码。 http://httpbin.org/get?name=%E5%BE%80%E4%BA%8B&amp;age=18</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>打印信息如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>http://httpbin.org/get?name=%E5%BE%80%E4%BA%8B&amp;age=18
<span class="linenos" data-linenos="2 "></span>200
<span class="linenos" data-linenos="3 "></span>{&#39;args&#39;: {&#39;age&#39;: &#39;18&#39;, &#39;name&#39;: &#39;往事&#39;}, &#39;headers&#39;: {&#39;Accept&#39;: &#39;*/*&#39;, &#39;Accept-Encoding&#39;: &#39;gzip, deflate&#39;, &#39;Host&#39;: &#39;httpbin.org&#39;, &#39;User-Agent&#39;: &#39;Python/3.7 aiohttp/3.7.4.post0&#39;, &#39;X-Amzn-Trace-Id&#39;: &#39;Root=1-60f91f13-251dc88719629bd04e8fc521&#39;}, &#39;origin&#39;: &#39;xxx.xx.xx&#39;, &#39;url&#39;: &#39;http://httpbin.org/get?name=往事&amp;age=18&#39;}
</code></pre></div>
<h4 id="3-%E6%A1%88%E4%BE%8B%E4%B8%80%E7%BD%91%E7%BB%9C%E5%9B%BE%E7%89%87%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0">3. 案例一：网络图片下载到本地</h4>
<p>一般情况下，网络图片都是可以通过<code>get</code>请求访问到的。</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">file_name</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="linenos" data-linenos="11 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;下载成功，文件名为：&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://img2.baidu.com/it/u=4025475678,645544065&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg&#39;</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">))</span>
</code></pre></div>
<h3 id="%E4%BA%8C-aiohttp%E7%9A%84post%E8%AF%B7%E6%B1%82">(二). aiohttp的post请求</h3>
<h4 id="1-%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82_1">1. 简单请求</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;状态码:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;请求方式&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Content-type:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">])</span>
<span class="linenos" data-linenos="10 "></span>            <span class="n">data_dict</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos" data-linenos="11 "></span>            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
<span class="linenos" data-linenos="12 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="15 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<h4 id="2-post%E4%BC%A0%E5%8F%82">2. POST传参</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;往事&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>打印信息如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>http://httpbin.org/post
<span class="linenos" data-linenos="2 "></span>200
<span class="linenos" data-linenos="3 "></span>{&#39;args&#39;: {}, &#39;data&#39;: &#39;&#39;, &#39;files&#39;: {}, &#39;form&#39;: {&#39;age&#39;: &#39;18&#39;, &#39;name&#39;: &#39;往事&#39;}, &#39;headers&#39;: {&#39;Accept&#39;: &#39;*/*&#39;, &#39;Accept-Encoding&#39;: &#39;gzip, deflate&#39;, &#39;Content-Length&#39;: &#39;30&#39;, &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;, &#39;Host&#39;: &#39;httpbin.org&#39;, &#39;User-Agent&#39;: &#39;Python/3.7 aiohttp/3.7.4.post0&#39;, &#39;X-Amzn-Trace-Id&#39;: &#39;Root=1-60f91e96-3406e8d07a97910d348a78f2&#39;}, &#39;json&#39;: None, &#39;origin&#39;: &#39;xx.xx.xxx&#39;, &#39;url&#39;: &#39;http://httpbin.org/post&#39;}
</code></pre></div>
<h3 id="%E4%B8%89-%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9">(三). 响应内容</h3>
<h4 id="1-%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9-text">1. 响应内容 text()</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</code></pre></div>
<p>上面响应的内容是字符串<code>str</code>。您还可以指定自定义编码：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="2-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9-read">2. 二进制响应内容 read()</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div>
<p>上面输入响应的内容是二进制<code>bytes</code>。如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>b&#39;内容..&#39;&#39;
</code></pre></div>
<h4 id="3-%E5%93%8D%E5%BA%94-json%E6%95%B0%E6%8D%AE">3. 响应 json数据</h4>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">data_dict</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>
<p>针对请求头<code>content-type</code>等于<code>application/json</code>生效。获取的数据才会比较美观。另外<code>json</code>方法还可以编码：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span><span class="n">data_dict</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="4-%E5%85%B6%E4%BB%96">4. 其他</h4>
<ul>
<li><code>response.status</code>：请求的状态码。比如：<code>200</code>。</li>
<li><code>response.method</code>：请求的方式。比如：<code>GET</code>，<code>POST</code>等。</li>
<li><code>response.url</code>：请求的链接URL。</li>
</ul>
<h3 id="%E5%9B%9B%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%E8%AE%BE%E7%BD%AE">(四).请求超时设置</h3>
<p>超时设置存储在<a href="https://docs.aiohttp.org/en/stable/client_reference.html#aiohttp.ClientTimeout"><code>ClientTimeout</code></a>数据结构中。</p>
<p>默认情况下，<code>aiohttp</code>使用*总共<code>*300 秒（5 分钟）</code>的超时时间，这意味着整个操作应该在 <code>5</code>分钟内完成。怎么设置超时呢？示例如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># total以秒为单位</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/get&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>
<span class="linenos" data-linenos="10 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="12 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>会话设置<code>timeout</code>。也可针对请求链接来设置<code>timeout</code>。如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 6 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/get&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>
<span class="linenos" data-linenos=" 9 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="11 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>如果<code>http://httpbin.org/get</code>在<code>1</code>秒内没有响应的话就会报错：<code>concurrent.futures._base.TimeoutError</code>。</p>
<h3 id="%E4%BA%94-%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86">(五). 其他知识</h3>
<p>除了<code>get</code>和<code>post</code>请求外，还有其他的请求，比如：<code>put</code>，<code>delete</code>等。参考文档：<a href="https://docs.aiohttp.org/en/stable/client_quickstart.html#make-a-request">https://docs.aiohttp.org/en/stable/client_quickstart.html#make-a-request</a></p>
<h2 id="%E4%B8%89-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0">三. 文件上传</h2>
<h3 id="%E4%B8%80-%E7%AE%80%E5%8D%95%E4%B8%8A%E4%BC%A0">(一). 简单上传</h3>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 5 "></span>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://httpbin.org/post&#39;</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;5742255ed7d4463cacbdec57c4b256be.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)}</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">files</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>            <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>200
<span class="linenos" data-linenos=" 2 "></span>{
<span class="linenos" data-linenos=" 3 "></span>  &quot;args&quot;: {},
<span class="linenos" data-linenos=" 4 "></span>  &quot;data&quot;: &quot;&quot;,
<span class="linenos" data-linenos=" 5 "></span>  &quot;files&quot;: {
<span class="linenos" data-linenos=" 6 "></span>    &quot;file&quot;: &quot;data:image/png;base64,/9j/42VJA64x25rPRm9pLU6vwpolxcXKxRugluYTiRSD5CbsE4/vEdB24q5qHg5ZdZYRutjpYZY4nkJkkmI4LBRycn6Co7OA2c8CCWb7MqA3DIhEhAHZumD7c12qX+nTW6Pp0U0kvl7BI0RQKvu7dB+tefXcozujOFTqUIPDgtLxFR7y9aM/eup8L9cVekaTfKy6tY2dy5CCRZRKyDjKqCQFP4V554g1KQ6lLpJnlSKInezZXzpPX/d6YHfrXQ6N4V0jVPDPnREveyoRG4bBScZyhGcYPGKyqx5YqUnktuW3PCc/umPUjHQH1+gPQU5L6xUHAnRiOXGHH4dK54wi37x18zGWcFrHMskmnoSnK/Ow598k5HtSXkhuLiSZ1AZjnjt7VM01u...&quot;
<span class="linenos" data-linenos=" 7 "></span> },
<span class="linenos" data-linenos=" 8 "></span>  &quot;form&quot;: {},
<span class="linenos" data-linenos=" 9 "></span>  &quot;headers&quot;: {
<span class="linenos" data-linenos="10 "></span>    &quot;Accept&quot;: &quot;*/*&quot;,
<span class="linenos" data-linenos="11 "></span>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
<span class="linenos" data-linenos="12 "></span>    &quot;Content-Length&quot;: &quot;54690&quot;,
<span class="linenos" data-linenos="13 "></span>    &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=a33f389018734854b9d5bd216b0c7b7d&quot;,
<span class="linenos" data-linenos="14 "></span>    &quot;Host&quot;: &quot;httpbin.org&quot;,
<span class="linenos" data-linenos="15 "></span>    &quot;User-Agent&quot;: &quot;Python/3.7 aiohttp/3.7.4.post0&quot;,
<span class="linenos" data-linenos="16 "></span>    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-60f92dea-5e76f16172bfd8035cf76057&quot;
<span class="linenos" data-linenos="17 "></span>  },
<span class="linenos" data-linenos="18 "></span>  &quot;json&quot;: null,
<span class="linenos" data-linenos="19 "></span>  &quot;origin&quot;: &quot;xxxxxxx&quot;,
<span class="linenos" data-linenos="20 "></span>  &quot;url&quot;: &quot;http://httpbin.org/post&quot;
<span class="linenos" data-linenos="21 "></span>}
</code></pre></div>
<p>或者显式设置<code>filename</code>和<code>content_type</code>：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">FormData</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://httpbin.org/post&#39;</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="n">data</span> <span class="o">=</span> <span class="n">FormData</span><span class="p">()</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">data</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="10 "></span>                   <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;5742255ed7d4463cacbdec57c4b256be.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span>
<span class="linenos" data-linenos="11 "></span>                   <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;5742255ed7d4463cacbdec57c4b256be.png&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="12 "></span>                   <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/png&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos="14 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos="15 "></span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="16 "></span>            <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="19 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="20 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>也可以不设置<code>content_type</code>。</p>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>200
<span class="linenos" data-linenos=" 2 "></span>{
<span class="linenos" data-linenos=" 3 "></span>  &quot;args&quot;: {},
<span class="linenos" data-linenos=" 4 "></span>  &quot;data&quot;: &quot;&quot;,
<span class="linenos" data-linenos=" 5 "></span>  &quot;files&quot;: {
<span class="linenos" data-linenos=" 6 "></span>    &quot;file&quot;: &quot;data:image/png;base64,/9j/42VJA64x25rPRm9pLU6vwpolxcXKxRugluYTiRSD5CbsE4/vEdB24q5qHg5ZdZYRutjpYZY4nkJkkmI4LBRycn6Co7OA2c8CCWb7MqA3DIhEhAHZumD7c12qX+nTW6Pp0U0kvl7BI0RQKvu7dB+tefXcozujOFTqUIPDgtLxFR7y9aM/eup8L9cVekaTfKy6tY2dy5CCRZRKyDjKqCQFP4V554g1KQ6lLpJnlSKInezZXzpPX/d6YHfrXQ6N4V0jVPDPnREveyoRG4bBScZyhGcYPGKyqx5YqUnktuW3PCc/umPUjHQH1+gPQU5L6xUHAnRiOXGHH4dK54wi37x18zGWcFrHMskmnoSnK/Ow598k5HtSXkhuLiSZ1AZjnjt7VM01u...&quot;
<span class="linenos" data-linenos=" 7 "></span> },
<span class="linenos" data-linenos=" 8 "></span>  &quot;form&quot;: {},
<span class="linenos" data-linenos=" 9 "></span>  &quot;headers&quot;: {
<span class="linenos" data-linenos="10 "></span>    &quot;Accept&quot;: &quot;*/*&quot;,
<span class="linenos" data-linenos="11 "></span>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
<span class="linenos" data-linenos="12 "></span>    &quot;Content-Length&quot;: &quot;54690&quot;,
<span class="linenos" data-linenos="13 "></span>    &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=a33f389018734854b9d5bd216b0c7b7d&quot;,
<span class="linenos" data-linenos="14 "></span>    &quot;Host&quot;: &quot;httpbin.org&quot;,
<span class="linenos" data-linenos="15 "></span>    &quot;User-Agent&quot;: &quot;Python/3.7 aiohttp/3.7.4.post0&quot;,
<span class="linenos" data-linenos="16 "></span>    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-60f92dea-5e76f16172bfd8035cf76057&quot;
<span class="linenos" data-linenos="17 "></span>  },
<span class="linenos" data-linenos="18 "></span>  &quot;json&quot;: null,
<span class="linenos" data-linenos="19 "></span>  &quot;origin&quot;: &quot;xxxxxxx&quot;,
<span class="linenos" data-linenos="20 "></span>  &quot;url&quot;: &quot;http://httpbin.org/post&quot;
<span class="linenos" data-linenos="21 "></span>}
</code></pre></div>
<p>如果您将文件对象作为数据参数传递，<code>aiohttp</code>将自动将其流式传输到服务器。</p>
<h2 id="%E5%9B%9B-%E6%B5%81%E5%BC%8F%E4%B8%8A%E4%BC%A0">四. 流式上传</h2>
<p><a href="https://docs.aiohttp.org/en/stable/structures.html#module-aiohttp"><code>aiohttp</code></a> 支持多种类型的流式上传，让您无需将大文件读入内存即可发送。</p>
<h3 id="%E4%B8%80-%E7%B1%BB%E4%BC%BC%E4%BA%8E%E6%96%87%E4%BB%B6%E5%AF%B9%E8%B1%A1%E4%B8%8A%E4%BC%A0">(一). 类似于文件对象上传</h3>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;5742255ed7d4463cacbdec57c4b256be.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>                <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="linenos" data-linenos="10 "></span>
<span class="linenos" data-linenos="11 "></span>
<span class="linenos" data-linenos="12 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="14 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>输出内容类似如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>{
<span class="linenos" data-linenos=" 2 "></span>  &quot;args&quot;: {},
<span class="linenos" data-linenos=" 3 "></span>  &quot;data&quot;: &quot;data:application/octet-stream;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0ku5GNvp8ZGR5pB+dvYDP5e9FFduIk44dWPPwsFLEu/mfOtzdT3t1Nc3ErSTyuXkkc5ZmPJJPrRRRXmLY9w//2Q==....&quot;,
<span class="linenos" data-linenos=" 4 "></span>  &quot;files&quot;: {},
<span class="linenos" data-linenos=" 5 "></span>  &quot;form&quot;: {},
<span class="linenos" data-linenos=" 6 "></span>  &quot;headers&quot;: {
<span class="linenos" data-linenos=" 7 "></span>    &quot;Accept&quot;: &quot;*/*&quot;,
<span class="linenos" data-linenos=" 8 "></span>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
<span class="linenos" data-linenos=" 9 "></span>    &quot;Content-Type&quot;: &quot;image/png&quot;,
<span class="linenos" data-linenos="10 "></span>    &quot;Host&quot;: &quot;httpbin.org&quot;,
<span class="linenos" data-linenos="11 "></span>    &quot;Transfer-Encoding&quot;: &quot;chunked&quot;,
<span class="linenos" data-linenos="12 "></span>    &quot;User-Agent&quot;: &quot;Python/3.7 aiohttp/3.7.4.post0&quot;,
<span class="linenos" data-linenos="13 "></span>    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-60f92f6e-050ca5470130229062379770&quot;
<span class="linenos" data-linenos="14 "></span>  },
<span class="linenos" data-linenos="15 "></span>  &quot;json&quot;: null,
<span class="linenos" data-linenos="16 "></span>  &quot;origin&quot;: &quot;xxxxxxxxx&quot;,
<span class="linenos" data-linenos="17 "></span>  &quot;url&quot;: &quot;http://httpbin.org/post&quot;
<span class="linenos" data-linenos="18 "></span>}
</code></pre></div>
<h3 id="%E4%BA%8C-%E9%87%87%E7%94%A8%E5%BC%82%E6%AD%A5%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8A%E4%BC%A0">(二). 采用异步生成器上传</h3>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiofiles</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">file_sender</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos" data-linenos=" 9 "></span>            <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>            <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>                <span class="k">yield</span> <span class="n">chunk</span>
<span class="linenos" data-linenos="12 "></span>                <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos="15 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">file_sender</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;5742255ed7d4463cacbdec57c4b256be.png&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
<span class="linenos" data-linenos="16 "></span>            <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span>
<span class="linenos" data-linenos="19 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="20 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="21 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>{
<span class="linenos" data-linenos=" 2 "></span>  &quot;args&quot;: {},
<span class="linenos" data-linenos=" 3 "></span>  &quot;data&quot;: &quot;data:application/octet-stream;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0ku5GNvp8ZGR5pB+dvYDP5e9FFduIk44dWPPwsFLEu/mfOtzdT3t1Nc3ErSTyuXkkc5ZmPJJPrRRRXmLY9w//2Q==....&quot;,
<span class="linenos" data-linenos=" 4 "></span>  &quot;files&quot;: {},
<span class="linenos" data-linenos=" 5 "></span>  &quot;form&quot;: {},
<span class="linenos" data-linenos=" 6 "></span>  &quot;headers&quot;: {
<span class="linenos" data-linenos=" 7 "></span>    &quot;Accept&quot;: &quot;*/*&quot;,
<span class="linenos" data-linenos=" 8 "></span>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
<span class="linenos" data-linenos=" 9 "></span>    &quot;Content-Type&quot;: &quot;image/png&quot;,
<span class="linenos" data-linenos="10 "></span>    &quot;Host&quot;: &quot;httpbin.org&quot;,
<span class="linenos" data-linenos="11 "></span>    &quot;Transfer-Encoding&quot;: &quot;chunked&quot;,
<span class="linenos" data-linenos="12 "></span>    &quot;User-Agent&quot;: &quot;Python/3.7 aiohttp/3.7.4.post0&quot;,
<span class="linenos" data-linenos="13 "></span>    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-60f92f6e-050ca5470130229062379770&quot;
<span class="linenos" data-linenos="14 "></span>  },
<span class="linenos" data-linenos="15 "></span>  &quot;json&quot;: null,
<span class="linenos" data-linenos="16 "></span>  &quot;origin&quot;: &quot;xxxxxxxxx&quot;,
<span class="linenos" data-linenos="17 "></span>  &quot;url&quot;: &quot;http://httpbin.org/post&quot;
<span class="linenos" data-linenos="18 "></span>}
</code></pre></div>
<h3 id="%E4%B8%89-%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E6%B5%81%E5%BC%8F%E4%B8%8A%E4%BC%A0">(三). 另外一种流式上传</h3>
<p>通过访问网络上的文件，把请求的内容<code>content</code>作为<code>data</code>参数值然后直接上传到服务器上。示例如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos=" 6 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 7 "></span>        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://img2.baidu.com/it/u=4025475678,645544065&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>                <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="linenos" data-linenos="12 "></span>                <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
<span class="linenos" data-linenos="13 "></span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="16 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>这样的好处是：不需要下载到本地就可以直接上传到了服务器上。</p>
<p>输入内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span>200 https://img2.baidu.com/it/u=4025475678,645544065&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg
<span class="linenos" data-linenos=" 2 "></span>200
<span class="linenos" data-linenos=" 3 "></span>{
<span class="linenos" data-linenos=" 4 "></span>  &quot;args&quot;: {},
<span class="linenos" data-linenos=" 5 "></span>  &quot;data&quot;: &quot;data:application/octet-stream;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcp2ZSHmfUB9slP+8PlH4KF/Emu+oorAtDJ5lggeVz8iKWb6CuI8VvNe6Xp+iK5S68QXIjlcHGy3A3yjP+4u3/AIFRRT6Gd/fSO4jjWKNY0UIigKqgcADsK56y8SC58e6r4dYf8etpBOhx13Ft380/Wiioexocp4HsgmqpbN92zknQf8AkZB/jXp2KKK6sQ7yXojkwq0l6s8n1hi+s3pHTz3H61S1XWo/BvhSfxFIgku5GNvp8ZGR5pB+dvYDP5e9FFduIk44dWPPwsFLEu/mfOtzdT3t1Nc3ErSTyuXkkc5ZmPJJPrRRRXmLY9w//2Q==...&quot;,
<span class="linenos" data-linenos=" 6 "></span>  &quot;files&quot;: {},
<span class="linenos" data-linenos=" 7 "></span>  &quot;form&quot;: {},
<span class="linenos" data-linenos=" 8 "></span>  &quot;headers&quot;: {
<span class="linenos" data-linenos=" 9 "></span>    &quot;Accept&quot;: &quot;*/*&quot;,
<span class="linenos" data-linenos="10 "></span>    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
<span class="linenos" data-linenos="11 "></span>    &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,
<span class="linenos" data-linenos="12 "></span>    &quot;Host&quot;: &quot;httpbin.org&quot;,
<span class="linenos" data-linenos="13 "></span>    &quot;Transfer-Encoding&quot;: &quot;chunked&quot;,
<span class="linenos" data-linenos="14 "></span>    &quot;User-Agent&quot;: &quot;Python/3.7 aiohttp/3.7.4.post0&quot;,
<span class="linenos" data-linenos="15 "></span>    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-60f93438-6c796a957f9118ad153dfd6e&quot;
<span class="linenos" data-linenos="16 "></span>  },
<span class="linenos" data-linenos="17 "></span>  &quot;json&quot;: null,
<span class="linenos" data-linenos="18 "></span>  &quot;origin&quot;: &quot;14.120.105.179&quot;,
<span class="linenos" data-linenos="19 "></span>  &quot;url&quot;: &quot;http://httpbin.org/post&quot;
<span class="linenos" data-linenos="20 "></span>}
</code></pre></div>
<h2 id="%E4%BA%94-%E7%88%AC%E8%99%AB%E6%A1%88%E4%BE%8B">五. 爬虫案例</h2>
<h3 id="%E4%B8%80-%E7%AE%80%E5%8D%95%E7%88%AC%E8%99%AB">(一). 简单爬虫</h3>
<p>使用<code>aiohttp</code>实现一个简单的爬虫程序，爬取四张图片。示例如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 4 "></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">get_html</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
<span class="linenos" data-linenos=" 8 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;当前发送的请求：&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="n">filename</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
<span class="linenos" data-linenos="10 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos="11 "></span>        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos" data-linenos="12 "></span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
<span class="linenos" data-linenos="13 "></span>            <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="linenos" data-linenos="14 "></span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">下载成功&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos="18 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos="19 "></span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos" data-linenos="20 "></span>        <span class="n">url_list</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="21 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=4247656867,4135832390&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="22 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=52681052,678098948&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1000&amp;h=400&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="23 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=2225026830,2981146689&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="24 "></span>            <span class="s1">&#39;https://img0.baidu.com/it/u=3767597885,3914306480&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=889&amp;h=500&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="25 "></span>        <span class="p">]</span>
<span class="linenos" data-linenos="26 "></span>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">get_html</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">]</span>
<span class="linenos" data-linenos="27 "></span>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="linenos" data-linenos="28 "></span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos" data-linenos="29 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;所用时间:</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">秒&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="30 "></span>
<span class="linenos" data-linenos="31 "></span>
<span class="linenos" data-linenos="32 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="33 "></span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>解释：</p>
<p><code>asyncio.create_task()</code>创建<code>4</code>个协程任务。</p>
<p><code>asyncio.wait()</code>挂起任务（异步执行）。</p>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>当前发送的请求： https://img2.baidu.com/it/u=4247656867,4135832390&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg
<span class="linenos" data-linenos="2 "></span>当前发送的请求： https://img2.baidu.com/it/u=52681052,678098948&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1000&amp;h=400
<span class="linenos" data-linenos="3 "></span>当前发送的请求： https://img2.baidu.com/it/u=2225026830,2981146689&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg
<span class="linenos" data-linenos="4 "></span>当前发送的请求： https://img0.baidu.com/it/u=3767597885,3914306480&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=889&amp;h=500
<span class="linenos" data-linenos="5 "></span>90ed0f40b4224a04a9de3336b85e754d.png下载成功
<span class="linenos" data-linenos="6 "></span>c5497bc85f574d79811481b080cc3ffb.png下载成功
<span class="linenos" data-linenos="7 "></span>efd85c8a6bdd4698a3c200d8217cc84f.png下载成功
<span class="linenos" data-linenos="8 "></span>7ed4d41892d34ac0b2fb8b30bbbb138b.png下载成功
<span class="linenos" data-linenos="9 "></span>所用时间:0.1秒
</code></pre></div>
<p>上面的程序是获取不了返回值的。</p>
<h3 id="%E4%BA%8C-%E6%94%B9%E8%BF%9B%E7%AE%80%E5%8D%95%E7%88%AC%E8%99%AB%E7%9A%84%E7%A8%8B%E5%BA%8F">(二). 改进简单爬虫的程序</h3>
<p>如果我想获取到每个任务的返回值呢。示例如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 6 "></span>
<span class="linenos" data-linenos=" 7 "></span>
<span class="linenos" data-linenos=" 8 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">get_html</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
<span class="linenos" data-linenos=" 9 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;当前发送的请求：&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="linenos" data-linenos="10 "></span>    <span class="n">filename</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
<span class="linenos" data-linenos="11 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
<span class="linenos" data-linenos="14 "></span>            <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="linenos" data-linenos="15 "></span>    <span class="k">return</span> <span class="n">filename</span>
<span class="linenos" data-linenos="16 "></span>
<span class="linenos" data-linenos="17 "></span>
<span class="linenos" data-linenos="18 "></span><span class="c1"># 这里默认传入一个future对象</span>
<span class="linenos" data-linenos="19 "></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
<span class="linenos" data-linenos="20 "></span>    <span class="c1"># print(dir(future))  # 查看有什么方法或属性可用</span>
<span class="linenos" data-linenos="21 "></span>    <span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>  <span class="c1"># 获取返回值</span>
<span class="linenos" data-linenos="22 "></span>
<span class="linenos" data-linenos="23 "></span>
<span class="linenos" data-linenos="24 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos" data-linenos="25 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos="26 "></span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos" data-linenos="27 "></span>        <span class="n">url_list</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos" data-linenos="28 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=4247656867,4135832390&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="29 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=52681052,678098948&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1000&amp;h=400&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="30 "></span>            <span class="s1">&#39;https://img2.baidu.com/it/u=2225026830,2981146689&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="31 "></span>            <span class="s1">&#39;https://img0.baidu.com/it/u=3767597885,3914306480&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=889&amp;h=500&#39;</span><span class="p">,</span>
<span class="linenos" data-linenos="32 "></span>        <span class="p">]</span>
<span class="linenos" data-linenos="33 "></span>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">get_html</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">]</span>
<span class="linenos" data-linenos="34 "></span>        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
<span class="linenos" data-linenos="35 "></span>            <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="linenos" data-linenos="36 "></span>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="linenos" data-linenos="37 "></span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="linenos" data-linenos="38 "></span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;所用时间:</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">秒&#39;</span><span class="p">)</span>
<span class="linenos" data-linenos="39 "></span>
<span class="linenos" data-linenos="40 "></span>
<span class="linenos" data-linenos="41 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="42 "></span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>其中<code>add_done_callback</code>接收的参数是一个回调函数。只要有任务执行完毕就会执行<code>add_done_callback</code>中的函数。回调函数<code>callback</code>只有一个参数<code>future</code>。这样子就可以在<code>callback</code>中处理您自己的逻辑了。比如：保存数据或者记录一下日志等。</p>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>当前发送的请求： https://img2.baidu.com/it/u=4247656867,4135832390&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg
<span class="linenos" data-linenos="2 "></span>当前发送的请求： https://img2.baidu.com/it/u=52681052,678098948&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1000&amp;h=400
<span class="linenos" data-linenos="3 "></span>当前发送的请求： https://img2.baidu.com/it/u=2225026830,2981146689&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg
<span class="linenos" data-linenos="4 "></span>当前发送的请求： https://img0.baidu.com/it/u=3767597885,3914306480&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=889&amp;h=500
<span class="linenos" data-linenos="5 "></span>dddbc4064d7b4bb78d782ec3c06373cc.png
<span class="linenos" data-linenos="6 "></span>8ed1678cba9f4e2cb84acf6987ebd65a.png
<span class="linenos" data-linenos="7 "></span>b31e3827ab5345f1bf4e81c26c134811.png
<span class="linenos" data-linenos="8 "></span>487e86ab1afa4efaa57be671aba4331f.png
<span class="linenos" data-linenos="9 "></span>所用时间:0.2秒
</code></pre></div>
<h2 id="%E5%85%AD-asyncio%E8%8E%B7%E5%8F%96%E5%8D%8F%E7%A8%8B%E8%BF%94%E5%9B%9E%E5%80%BC%E5%92%8C%E4%BD%BF%E7%94%A8callback">六. asyncio获取协程返回值和使用callback</h2>
<h3 id="%E4%B8%80-loop%E8%87%AA%E5%B8%A6%E7%9A%84create_task%E5%8F%AF%E4%BB%A5%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E8%BF%94%E5%9B%9E%E5%80%BC">(一). loop自带的create_task可以快速获取返回值</h3>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos=" 1 "></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="linenos" data-linenos=" 2 "></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="linenos" data-linenos=" 3 "></span><span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="linenos" data-linenos=" 4 "></span>
<span class="linenos" data-linenos=" 5 "></span>
<span class="linenos" data-linenos=" 6 "></span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="linenos" data-linenos=" 7 "></span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos" data-linenos=" 8 "></span>        <span class="n">filename</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
<span class="linenos" data-linenos=" 9 "></span>        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
<span class="linenos" data-linenos="10 "></span>            <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="linenos" data-linenos="11 "></span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_object</span><span class="p">:</span>
<span class="linenos" data-linenos="12 "></span>                <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="linenos" data-linenos="13 "></span>        <span class="k">return</span> <span class="n">filename</span>
<span class="linenos" data-linenos="14 "></span>
<span class="linenos" data-linenos="15 "></span>
<span class="linenos" data-linenos="16 "></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos" data-linenos="17 "></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="linenos" data-linenos="18 "></span>    <span class="n">task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="s2">&quot;https://img2.baidu.com/it/u=2225026830,2981146689&amp;fm=11&amp;fmt=auto&amp;gp=0.jpg&quot;</span><span class="p">))</span>
<span class="linenos" data-linenos="19 "></span>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<span class="linenos" data-linenos="20 "></span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;返回值&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</code></pre></div>
<p>输出内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="linenos" data-linenos="1 "></span>返回值 da3d948408e747f597b8d123674748fb.png
</code></pre></div>
            </main>

            <div class="d-flex justify-content-between mb-3">

                    <div>上一篇: <a href="/p/dad313fea8e44ecdbf1b3c157107bd56">cookie的介绍</a></div>


                    <div class="">下一篇: <a href="/p/6cb2f3d17df64003823c0fc5f29dfd1e">python之playwright的用法</a></div>

            </div>




        </div>
        <div class="col-lg-2 md-block md-hidden" id="cate_dir">
            <div class="catalog">
                <h6 class="text-center">文章目录</h6>
                <div class="k-catelog-list list-unstyled" id="catelogList"></div>
            </div>
            <ul class="tools list-unstyled mt-3">


                        <li class="tool">
                            <a href="http://sighttp.qq.com/authd?IDKEY=04cbaa7f28c188b7eb7e06572173c531e8b39420831a4901"
                               target="_blank">
                                <div class="kef an" style="background-image:url(/static/images/5ATUrF.png)"></div>
                                <span class="toolti">遇到问题就咨询作者</span></a>
                        </li>


                <li class="tool" id="goTop">
                    <div class="kef"><i class="fa-solid fa-jet-fighter-up"></i></div>
                </li>
            </ul>
        </div>
    </div>


    <footer class="text-muted py-3 bg-light mt-3">
  <div class="container">
    <p class="float-end mb-1">
      <a href="/">返回首页</a>
    </p>
    <p class="mb-1">Copyright ©2018-2023 <a href="https://beian.miit.gov.cn">粤ICP备18155425号 </a> shugeyuan.cn 版权所有</p>
  </div>
</footer>
    </div>
</body>

    <script src="/static/js/jquery-2.0.0.min.js"></script>
    <script src="/static/js/bootstrap1.min.js"></script>


    <script src="/static/js/clipboard.min.js"></script>
    <script src="/static/js/katelog.min.js"></script>
    <script src="/static/detail.min.js"></script>

</html>